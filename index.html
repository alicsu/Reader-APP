<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/style.css">
	<title>reader</title>
</head>
<body>
	<div id="root" class="container">
		<div class="m-artical-action">
			<div class="artical-action-middle" id="action_mid"></div>
		</div>
		<div id="top_nav" class="top-nav" style="display:none">
			<div class="icon-back"></div>
			<div class="nav-title">返回书架</div>
		</div>
		<div id="fiction_chapter_title"></div>
		<div id="fiction_container" class="m-read-content">
			<h4>小说</h4>
			<p>
				人物、情节、环境是小说的三要素。情节一般包括开端、发展、高潮、结局四部分，有的包括序幕、尾声。环境包括自然环境和社会环境。 小说按照篇幅及容量可分为长篇、中篇、短篇和微型小说（小小说）。按照表现的内容可分为神话、科幻、公案、传奇、武侠、言情、同人、官宦、耽美等。按照体制可分为章回体小说、日记体小说、书信体小说、自传体小说。按照语言形式可分为文言小说和白话小说
			</p>
			<p>
				人物、情节、环境是小说的三要素。情节一般包括开端、发展、高潮、结局四部分，有的包括序幕、尾声。环境包括自然环境和社会环境。 小说按照篇幅及容量可分为长篇、中篇、短篇和微型小说（小小说）。按照表现的内容可分为神话、科幻、公案、传奇、武侠、言情、同人、官宦、耽美等。按照体制可分为章回体小说、日记体小说、书信体小说、自传体小说。按照语言形式可分为文言小说和白话小说
			</p>
			<p>
				人物、情节、环境是小说的三要素。情节一般包括开端、发展、高潮、结局四部分，有的包括序幕、尾声。环境包括自然环境和社会环境。 小说按照篇幅及容量可分为长篇、中篇、短篇和微型小说（小小说）。按照表现的内容可分为神话、科幻、公案、传奇、武侠、言情、同人、官宦、耽美等。按照体制可分为章回体小说、日记体小说、书信体小说、自传体小说。按照语言形式可分为文言小说和白话小说
			</p>
			<p>
				人物、情节、环境是小说的三要素。情节一般包括开端、发展、高潮、结局四部分，有的包括序幕、尾声。环境包括自然环境和社会环境。 小说按照篇幅及容量可分为长篇、中篇、短篇和微型小说（小小说）。按照表现的内容可分为神话、科幻、公案、传奇、武侠、言情、同人、官宦、耽美等。按照体制可分为章回体小说、日记体小说、书信体小说、自传体小说。按照语言形式可分为文言小说和白话小说
			</p>
		</div>
		<div class="m-button-bar">
			<ul class="u-tab">
				<li id="prev_button">上一章</li>
				<li id="next_button">下一章</li>
			</ul>
		</div>
		<div class="nav-pannel-bk font-container" style="display:none"></div>
		<div class="nav-pannel font-container" id="font-container" style="display:none">
			<div class="child-mod">
				<span>字号</span>
				<button id="large-font" class="font-size-button">大</button>
				<button id="small-font" class="font-size-button">小</button>
			</div>
			<div class="child-mod">
				<span>背景</span>
				<div class="bk-container color1">
					<div class="bk-container-current"></div>
				</div>
				<div class="bk-container color2">
					<div class="bk-container-current"></div>
				</div>
				<div class="bk-container color3">
					<div class="bk-container-current"></div>
				</div>
				<div class="bk-container color4">
					<div class="bk-container-current"></div>
				</div>
			</div>
		</div>
		<div class="bottom-nav-bk bottom_nav" style="display:none"></div>
		<div class="bottom-nav bottom_nav" style="display:none">
			<div class="item menu-button" id="menu_button">
				<div class="item-warp">
					<div class="icon-menu"></div>
					<div class="icon-text1">目录</div>
				</div>
			</div>
			<div class="item" id="font-button">
				<div class="item-warp">
					<div class="icon-ft"></div>
					<div class="icon-text2">字体</div>
				</div>
			</div>
			<div class="item" id="night-button">
				<div class="item-warp" id="day_icon">
					<div class="icon-day"></div>
					<div class="icon-text3">白天</div>
				</div>
				<div class="item-warp" id="night_icon" style="display:none">
					<div class="icon-night"></div>
					<div class="icon-text">夜间</div>
				</div>
			</div>
		</div>
	</div>
	<script src="lib/zepto.min.js"></script>
	<script>
		window.jQuery = $;

	</script>
	<script src="js/jQuery.Base64.js"></script>
	<script src="js/jQuery.jsonp.js"></script>
	<script>
		// 封装storageGetter和storageSetter函数，存储上的支持
		(function(){
			var Util = (function(){
				var prefix = 'html5_reader_';
				var StorageGetter = function(key){
					// localStorage中使用getItem和setItem来获取和设置值，主要是因为容易控制，便于动态绑定，尤其在函数抽离和重构中，
					return localStorage.getItem(prefix + key);
				}
				var StorageSetter = function(key,val){
					return localStorage.setItem(prefix + key,val);
				}
				var getBSONP = function(url,callback){
					return $.jsonp({
						url:url,
						cache:true,
						callback:'duokan_fiction_chapter',
						success:function(result){
							var data = $.base64.decode(result);
							var json = decodeURIComponent(escape(data));
							callback(data);
						}
					})
				}
				// 将函数暴露出去
				return {
					getBSONP:getBSONP,
					StorageGetter:StorageGetter,
					StorageSetter:StorageSetter
				}
			})();

			var Dom = {
				top_nav:$('#top_nav'),
				bottom_nav:$('.bottom_nav'),
				font_container:$('.font-container'),
				font_button:$('#font-button')
			}
			var Win = $(window);
			var Doc = $(document);
			var RootContainer = $('#fiction_container');
			var initFontSize = Util.StorageGetter('font_size');
			initFontSize = parseInt(initFontSize);
			if(!initFontSize){
				initFontSize = 14;
			}
			RootContainer.css('font-size',initFontSize)
			function main(){
				//todo 整个项目的入口函数
				var readerModel = ReaderModel();
				readerModel.init();
				EventHanlder();
			}
			function ReaderModel(){
				//todo 实现和阅读器相关的数据交互的方法
				var Chapter_id;
				var init = function(){
					getFictionInfo(function(){
						getChapterContent(Chapter_id)
					})
				}
				var getFictionInfo = function(callback){
					$.get('/data/chapter.json',function(){
						//todo 获得章节信息之后的回调
						Chapter_id = data.chapters[0].chapter_id;
						callback && callback();
					},'json');
				}
				var getCurChapterContent = function(chapter_id,data){
					$.get('data/data' + chapter_id + '.json',function(data){
						if(data.result == 0){
							var url = data.jsonp;
							Util.getBSONP(url,function(data){
								callback &&callback(data);
							});
						}
					},'json')
				}
			}

			function ReaderBaseFrame(){
				//todo 渲染基本的UI结构
				function parseChapterData(jsonData){
					var jsonObj = JSON.parse(jsonData);
					var html = '<h4>' + jsonObj.t + '</h4>';
					for(var i = 0;i < jsonObj.p.length;i++){
						html += "<p>" +jsonObj.p[i] + '</p>';
					}
					return html;
				}
				return function(data){
					container.html(parseChapterData(data));
				}
			}

			function EventHanlder(){
				// todo 交互的事件绑定
				$('#action_mid').click(function(){
					if(Dom.top_nav.css('display') == 'none'){
						Dom.bottom_nav.show();
						Dom.top_nav.show();
					}else{
						Dom.bottom_nav.hide();
						Dom.top_nav.hide();
						Dom.font_container.hide();
					}
				});
				Dom.font_button.click(function(){
					if(Dom.font_container.css('display') == 'none'){
						Dom.font_container.show();
						Dom.font_button.addClass('current');
					}else{
						Dom.font_container.hide();
						Dom.font_button.removeClass('current');
					}
				})
				$('#night-button').click(function(){
                        // todo 触发背景切换的事件
				});
				$('#large-font').click(function(){
					// 字体放大
					if(initFontSize > 20){return;}
					initFontSize += 1;
					RootContainer.css('font-size',initFontSize);
					Util.StorageSetter('font_size',initFontSize);
				});
				$('#small-font').click(function(){
					// 字体缩小
					if(initFontSize < 12){return;}
					initFontSize -= 1;
					RootContainer.css('font-size',initFontSize);
					Util.StorageSetter('font_size',initFontSize);
				})
                Win.scroll(function(){
                	Dom.bottom_nav.hide();
                	Dom.top_nav.hide();
                	Dom.font_container.hide();
                })
            }
			main();
		})();
	</script>
</body>
</html>